@inject HttpClient Http
@inject NavigationManager navManager
@inject AutoMapper.IMapper Mapper 
@inject PlanetManager planetManager
@inject AddChannelContextMenu contextMenu
@inject IJSRuntime JS
@inject CreateChannelModal createChannelModal
@using Valour.Shared.Categories

<section>
    <h2 class="create-component-title">Create a Channel</h2>

    <div asp-validation-summary="All" class="text-info"></div>
    <div class="form-group mt-2">
        <label>Channel Name</label>
        <input class="form-control" @bind-value="@name" />
    </div>
    <div style="margin-top:20px;">
        <div class="perm-list-name mb-1">
            Private Channel
        </div>
        <div type="button" style="float: right">
            <label class="switch">
                <input type="checkbox" @onclick="PrivateSwitch" checked="@isprivate">
                <span class="slider round"></span>
            </label>
        </div>
    </div>

    @if (isprivate) {
        <label style="margin-top: 12px;">Who can see and send messages in this channel?</label>
        <div class="create-component-roles-box">
            @foreach (Role role in Roles)
            {
                <div class="role">
                   <div class="perm-list-name mb-1" style="color: @role.GetColorHex();">
                        @role.Name
                    </div>
                    <div type="button" style="float: right">
                        <label class="switch">
                            <input type="checkbox" OnStateChange="SwitchRole(role)" checked="@SelectedRoles[role]">
                            <span class="slider round"></span>
                        </label>
                    </div> 
                </div>

            }
        </div>
    }

    <span id="image-span" style="color:#888888">@imageSpan</span>
    
    <div class="form-group mt-4">
        <center>
            <button class="btn btn-primary mt-2" @onclick="OnClickSubmit">Create</button>
        </center>
    </div>
</section>
@code {

    [Parameter, EditorRequired]
    public Planet Planet { get; set; }

    // Input fields
    string name;

    // Spans
    string imageSpan = "";
    Dictionary<Role, bool> SelectedRoles = new Dictionary<Role, bool>();

    List<Role> Roles = new List<Role>();
    bool isprivate = false;

    protected override async Task OnInitializedAsync() {
        Roles.Clear();
        SelectedRoles.Clear();

        Member SelfMember = (await Member.FindAsync(ClientUserManager.User.Id, planetManager.GetCurrent().Id)).Data;
        ulong SelfAuthority = (await SelfMember.GetAuthorityAsync()).Data;

        var roleResponse = await Planet.GetRolesAsync();

        if (!roleResponse.Success)
            return;

        foreach (Role item in roleResponse.Data)
        {
            if (item.GetAuthority() >= SelfAuthority)
                continue;
            Roles.Add(item);
            SelectedRoles.Add(item, false);
        }
        StateHasChanged();
    }

    private void SwitchRole(Role role) {
        SelectedRoles[role] = !SelectedRoles[role];
    }

    private void PrivateSwitch() {
        isprivate = !isprivate;
    }

    private async Task OnClickSubmit(MouseEventArgs e)
    {

        // Require a name
        if (string.IsNullOrWhiteSpace(name))
        {
            name = "Please input a channel name.";
            return;
        }


        ulong user_id = ClientUserManager.User.Id;
        string token = ClientUserManager.UserSecretToken;

        ulong parent_id = contextMenu.SelectedCategory.Id;
        ulong planet_id = contextMenu.SelectedCategory.Planet_Id;

        Channel newChannel = new()
        {
            Name = name,
            Planet_Id = planet_id,
            Parent_Id = parent_id
        };

        JsonContent content = JsonContent.Create(newChannel);

        var create_response = await Http.PostAsync($"api/planet/{planet_id}/channels", content);

        if (!create_response.IsSuccessStatusCode)
        {
            string errorText = $"Error ({create_response.StatusCode}): " + await create_response.Content.ReadAsStringAsync();
            Console.WriteLine(errorText);
            imageSpan = errorText;
            return;
        }

        ulong channel_id;
        bool id_parsed = ulong.TryParse(await create_response.Content.ReadAsStringAsync(), out channel_id);

        if (!id_parsed)
        {
            string errorText = "Error: Failed to parse result.";
            Console.WriteLine(errorText);
            imageSpan = errorText;
            return;
        }

        imageSpan = "Success.";

        if (isprivate) {
            // set the default role channel view perms to false

            PermissionsNode PermissionsNode = new()
            {
                Channel_Id = channel_id,
                Planet_Id = planetManager.GetCurrent().Id,
                Role_Id = planetManager.GetCurrent().Default_Role_Id,
                Mask = 0x00,
                Code = 0x00
            };

            PermissionsNode.SetPermission(ChatChannelPermissions.PostMessages, PermissionState.False);
            PermissionsNode.SetPermission(ChatChannelPermissions.ViewMessages, PermissionState.False);
            PermissionsNode.SetPermission(ChatChannelPermissions.View, PermissionState.False);

            HttpResponseMessage response = await ClientUserManager.Http.PostAsJsonAsync<PermissionsNode>($"Permissions/UpdateChatChannelNode?token={ClientUserManager.UserSecretToken}",
                                                                                                    PermissionsNode);

            if (!response.IsSuccessStatusCode)
            {
                string errorText = $"Error ({response.StatusCode}): " + await response.Content.ReadAsStringAsync();
                Console.WriteLine(errorText);
                imageSpan = errorText;
            }

            foreach (Role role in Roles)
            {
                
                if (!SelectedRoles[role]) {
                    continue;
                }
                
                PermissionsNode = new PermissionsNode()
                {
                    Channel_Id = channel_id,
                    Planet_Id = planetManager.GetCurrent().Id,
                    Role_Id = role.Id,
                    Mask = 0x00,
                    Code = 0x00
                };

                PermissionsNode.SetPermission(ChatChannelPermissions.PostMessages, PermissionState.True);
                PermissionsNode.SetPermission(ChatChannelPermissions.ViewMessages, PermissionState.True);
                PermissionsNode.SetPermission(ChatChannelPermissions.View, PermissionState.True);

                response = await ClientUserManager.Http.PostAsJsonAsync<PermissionsNode>($"api/node/channel", PermissionsNode);
                if (!response.IsSuccessStatusCode)
                {
                    string errorText = $"Error ({response.StatusCode}): " + await response.Content.ReadAsStringAsync();
                    Console.WriteLine(errorText);
                    imageSpan = errorText;
                }
            }
        }

        // close modal

        createChannelModal.Component.SetVisibility(false);

        
    }

    private async Task OnImageInput()
    {

    }
}
